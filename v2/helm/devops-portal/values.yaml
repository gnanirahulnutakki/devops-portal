# =============================================================================
# DevOps Portal v2 - Helm Values
# =============================================================================

replicaCount: 2

image:
  repository: ghcr.io/gnanirahulnutakki/devops-portal
  pullPolicy: IfNotPresent
  tag: ""  # Defaults to Chart appVersion

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# =============================================================================
# Pod Configuration
# =============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "3000"
  prometheus.io/path: "/api/metrics"

podLabels: {}

podSecurityContext:
  fsGroup: 1001
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  seccompProfile:
    type: RuntimeDefault

# =============================================================================
# Service
# =============================================================================
service:
  type: ClusterIP
  port: 80
  targetPort: 3000

# =============================================================================
# Ingress
# =============================================================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: devops-portal.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: devops-portal-tls
      hosts:
        - devops-portal.example.com

# =============================================================================
# Resources
# =============================================================================
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 250m
    memory: 512Mi

# =============================================================================
# Autoscaling
# =============================================================================
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# =============================================================================
# Pod Disruption Budget
# =============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# =============================================================================
# Probes
# =============================================================================
livenessProbe:
  httpGet:
    path: /api/health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /api/health
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# =============================================================================
# Node Selection
# =============================================================================
nodeSelector: {}
tolerations: []
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - devops-portal
          topologyKey: kubernetes.io/hostname

# =============================================================================
# Environment Configuration
# =============================================================================
env:
  NODE_ENV: production
  LOG_LEVEL: info

# Sensitive values from secrets
envFromSecrets:
  - name: devops-portal-secrets

# =============================================================================
# External Secrets (if using external-secrets operator)
# =============================================================================
externalSecrets:
  enabled: false
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  data: []
    # - secretKey: NEXTAUTH_SECRET
    #   remoteRef:
    #     key: devops-portal/nextauth
    #     property: secret

# =============================================================================
# PostgreSQL (Bitnami)
# =============================================================================
postgresql:
  enabled: true
  auth:
    username: devops_portal
    database: devops_portal
    existingSecret: devops-portal-postgresql
    secretKeys:
      adminPasswordKey: postgres-password
      userPasswordKey: password
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

# External database (if postgresql.enabled=false)
externalDatabase:
  host: ""
  port: 5432
  database: devops_portal
  username: devops_portal
  existingSecret: ""
  existingSecretPasswordKey: password

# =============================================================================
# Redis (Bitnami)
# =============================================================================
redis:
  enabled: true
  auth:
    enabled: true
    existingSecret: devops-portal-redis
    existingSecretPasswordKey: password
  master:
    persistence:
      enabled: true
      size: 2Gi
    resources:
      limits:
        cpu: 250m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi
  replica:
    replicaCount: 1

# External Redis (if redis.enabled=false)
externalRedis:
  host: ""
  port: 6379
  existingSecret: ""
  existingSecretPasswordKey: password

# =============================================================================
# Network Policy
# =============================================================================
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 443   # HTTPS (GitHub, ArgoCD, etc.)

# =============================================================================
# Service Monitor (Prometheus)
# =============================================================================
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  annotations: {}
