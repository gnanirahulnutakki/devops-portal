# Values for saasops1 deployment
# Namespace: duploservices-saasops1
# NodeSelector required: tenantname pointing to namespace
#
# Usage:
#   helm upgrade --install devops-portal ./deployment/helm \
#     -n duploservices-saasops1 \
#     -f deployment/helm/values-saasops1.yaml

replicaCount: 1

image:
  repository: rahulnutakki/backstage-gitops
  pullPolicy: Always
  tag: "v4"

nameOverride: "devops-portal"
fullnameOverride: "devops-portal"

serviceAccount:
  create: true
  annotations: {}
  name: "devops-portal"

# CRITICAL: NodeSelector for DuploCloud tenant scheduling
nodeSelector:
  tenantname: duploservices-saasops1

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "7007"
  prometheus.io/path: "/api/gitops/health?detailed=true"

podSecurityContext:
  fsGroup: 65534

securityContext:
  runAsNonRoot: true
  runAsUser: 65534
  runAsGroup: 65534
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false

service:
  type: ClusterIP
  port: 80
  targetPort: 7007
  annotations: {}

# ============================================================================
# Ingress Configuration - AWS ALB for DuploCloud
# ============================================================================
# nip.io usage: After deployment, get the ALB hostname:
#   kubectl get ingress -n duploservices-saasops1 devops-portal -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
# Then update the host to: devops-portal.<ALB-IP>.nip.io
# Or use the script: ./deployment/scripts/update-nip-io-host.sh
ingress:
  enabled: true
  className: alb
  
  # ALB-specific configuration for Duplo
  alb:
    scheme: internet-facing
    targetType: ip
    # Certificate ARN from ACM (optional - for HTTPS with custom domain)
    # certificateArn: arn:aws:acm:us-west-2:ACCOUNT_ID:certificate/CERT_ID
    # Duplo tags (required for proper resource tracking)
    tags: "duplo-project=saasops1,TENANT_NAME=saasops1"
    # ALB group for sharing (optional)
    # groupName: shared-alb
    # Health check configuration
    healthcheckPath: /
    successCodes: "200-399"
  
  # Additional annotations
  annotations: {}
  
  hosts:
    # Using nip.io for dynamic DNS - update after ALB is created
    # Format: <app-name>.<ALB-IP>.nip.io
    # Example: devops-portal.52-10-20-30.nip.io
    - host: devops-portal.nip.io
      paths:
        - path: /
          pathType: Prefix
  
  # TLS configuration (optional - ALB handles SSL termination with ACM)
  tls: []

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

appDist:
  writable: true

autoscaling:
  enabled: false

tolerations: []
affinity: {}

livenessProbe:
  httpGet:
    path: /
    port: 7007
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /
    port: 7007
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# ============================================================================
# PostgreSQL Configuration
# ============================================================================
postgres:
  enabled: true
  image:
    repository: postgres
    tag: "14"
  storage:
    size: 5Gi
    storageClass: duploservices-saasops1-encrypted-gp3
  host: ""
  port: 5432
  database: backstage
  username: backstage
  ssl:
    enabled: false
    rejectUnauthorized: false
  nodeSelector:
    tenantname: duploservices-saasops1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# ============================================================================
# GitHub Configuration
# ============================================================================
github:
  organization: radiantlogic-saas

# ============================================================================
# ArgoCD Configuration
# ============================================================================
argocd:
  enabled: true
  url: https://argocd.radiantlogic.com

# ============================================================================
# Authentication Configuration
# ============================================================================
auth:
  # Set to development to allow guest mode
  environment: development
  # Guest mode for quick testing without OAuth
  guest:
    enabled: true
    dangerouslyAllowOutsideDevelopment: true
  github:
    enabled: true
  google:
    enabled: false
  microsoft:
    enabled: false

gitopsAuth:
  allowUnauthenticated: false

# ============================================================================
# Grafana Configuration (optional)
# ============================================================================
grafana:
  enabled: false
  url: ""

# ============================================================================
# Backstage App Configuration
# ============================================================================
# Note: baseUrl will be updated after ingress is created with nip.io
backstage:
  baseUrl: http://devops-portal.nip.io
  logLevel: info

# ============================================================================
# Extra Environment Variables
# ============================================================================
extraEnv:
  - name: NODE_ENV
    value: "production"
  - name: LOG_LEVEL
    value: "info"

# ============================================================================
# Secrets Configuration
# ============================================================================
# Create secrets first:
#   kubectl create secret generic backstage-secrets -n duploservices-saasops1 \
#     --from-literal=GITHUB_TOKEN=<token> \
#     --from-literal=ARGOCD_TOKEN=<token> \
#     --from-literal=POSTGRES_PASSWORD=<password> \
#     --from-literal=GITHUB_OAUTH_CLIENT_ID=<client_id> \
#     --from-literal=GITHUB_OAUTH_CLIENT_SECRET=<client_secret> \
#     --from-literal=AUTH_SESSION_SECRET=$(openssl rand -hex 32)
secrets:
  create: false
  name: backstage-secrets
  githubToken:
    key: GITHUB_TOKEN
  argoCdToken:
    key: ARGOCD_TOKEN
  postgresPassword:
    key: POSTGRES_PASSWORD
  githubOAuthClientId:
    key: GITHUB_OAUTH_CLIENT_ID
  githubOAuthClientSecret:
    key: GITHUB_OAUTH_CLIENT_SECRET
  authSessionSecret:
    key: AUTH_SESSION_SECRET
