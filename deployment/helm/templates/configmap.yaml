apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "backstage-gitops.fullname" . }}-config
  labels:
    {{- include "backstage-gitops.labels" . | nindent 4 }}
data:
  app-config.production.yaml: |
    app:
      title: {{ .Values.backstage.title | default "DevOps Portal" }}
      baseUrl: {{ .Values.backstage.baseUrl }}

    organization:
      name: {{ .Values.organization.name | default "RadiantLogic" }}

    backend:
      baseUrl: {{ .Values.backstage.baseUrl }}
      listen:
        port: 7007
        host: 0.0.0.0
      csp:
        connect-src: ["'self'", 'http:', 'https:']
        {{- if .Values.grafana.enabled }}
        frame-src: ["'self'", '{{ .Values.grafana.url }}']
        {{- end }}
      cors:
        origin: {{ .Values.backstage.baseUrl }}
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: ${POSTGRES_DB}
          {{- if .Values.postgres.ssl.enabled }}
          ssl:
            require: true
            rejectUnauthorized: {{ .Values.postgres.ssl.rejectUnauthorized | default true }}
          {{- else }}
          ssl: false
          {{- end }}
      {{- if .Values.redis.enabled }}
      # Redis for session storage, caching, and optional queue support
      cache:
        store: redis
        connection: redis://${REDIS_HOST}:${REDIS_PORT}
        useRedisSets: true
      {{- else }}
      cache:
        store: memory
      {{- end }}
      reading:
        allow:
          - host: '*.githubusercontent.com'
          - host: 'raw.githubusercontent.com'
          {{- if .Values.grafana.enabled }}
          - host: '{{ .Values.grafana.url | trimPrefix "https://" | trimPrefix "http://" | regexFind "[^/]+" }}'
          {{- end }}

    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}
      {{- if .Values.gitlab.enabled }}
      gitlab:
        - host: {{ .Values.gitlab.host | default "gitlab.com" }}
          token: ${GITLAB_TOKEN}
          {{- if .Values.gitlab.apiBaseUrl }}
          apiBaseUrl: {{ .Values.gitlab.apiBaseUrl }}
          {{- end }}
      {{- end }}

    # ============================================================================
    # GitOps Plugin Configuration
    # ============================================================================
    gitops:
      github:
        organization: {{ .Values.github.organization | required "github.organization is required" }}
        token: ${GITHUB_TOKEN}
        useOAuthToken: {{ .Values.gitops.useOAuthToken | default true }}
      {{- if .Values.gitlab.enabled }}
      gitlab:
        enabled: true
        baseUrl: {{ .Values.gitlab.url | default "https://gitlab.com" }}
        token: ${GITLAB_TOKEN}
        useOAuthToken: {{ .Values.gitops.useOAuthToken | default true }}
      {{- end }}
      auth:
        # WARNING: Setting allowUnauthenticated=true bypasses auth for API calls
        # Only use in development/testing environments
        allowUnauthenticated: {{ .Values.gitopsAuth.allowUnauthenticated | default false }}
        requireAuthForWrites: {{ .Values.gitopsAuth.requireAuthForWrites | default true }}

      # ------------------------------------------------------------------------
      # ArgoCD Configuration - Cluster-specific with service account support
      # ------------------------------------------------------------------------
      {{- if .Values.argocd.enabled }}
      argocd:
        enabled: true
        url: {{ .Values.argocd.url }}
        {{- if .Values.argocd.useServiceAccount }}
        # Use in-cluster service account (more secure for same-cluster ArgoCD)
        useServiceAccount: true
        serviceAccountTokenPath: /var/run/secrets/kubernetes.io/serviceaccount/token
        {{- else }}
        # Use explicit token (for external or cross-cluster ArgoCD)
        token: ${ARGOCD_TOKEN}
        {{- end }}
        {{- if .Values.argocd.insecure }}
        insecure: true
        {{- end }}
        # Namespace where ArgoCD is deployed (for service account access)
        namespace: {{ .Values.argocd.namespace | default "argocd" }}
      {{- end }}

      # ------------------------------------------------------------------------
      # Grafana Configuration - Supports both Cloud and Local instances
      # ------------------------------------------------------------------------
      {{- if .Values.grafana.enabled }}
      grafana:
        enabled: true
        # Type: 'cloud' for Grafana Cloud, 'local' for self-hosted
        type: {{ .Values.grafana.type | default "local" }}
        url: {{ .Values.grafana.url }}
        {{- if eq (default "local" .Values.grafana.type) "cloud" }}
        # Grafana Cloud authentication
        cloudStackSlug: {{ .Values.grafana.cloudStackSlug | default "" }}
        serviceAccountToken: ${GRAFANA_SA_TOKEN}
        {{- else }}
        # Local/Self-hosted Grafana authentication
        {{- if .Values.grafana.useServiceAccount }}
        serviceAccountToken: ${GRAFANA_SA_TOKEN}
        {{- else }}
        apiKey: ${GRAFANA_API_KEY}
        {{- end }}
        {{- end }}
        # Optional: specific dashboard UIDs to display
        {{- if .Values.grafana.dashboards }}
        dashboards:
          {{- toYaml .Values.grafana.dashboards | nindent 10 }}
        {{- end }}
      {{- end }}

      # ------------------------------------------------------------------------
      # Uptime Kuma Configuration
      # ------------------------------------------------------------------------
      {{- if .Values.uptimeKuma.enabled }}
      uptimeKuma:
        enabled: true
        baseUrl: {{ .Values.uptimeKuma.url }}
        apiKey: ${UPTIME_KUMA_API_KEY}
      {{- end }}

    catalog:
      rules:
        - allow: [Component, System, API, Resource, Location, Group, User]
      locations:
        {{- if .Values.catalog.locations }}
        {{- toYaml .Values.catalog.locations | nindent 8 }}
        {{- end }}

    # ============================================================================
    # Authentication Configuration
    # ============================================================================
    auth:
      # Environment controls certain security behaviors
      # 'development' - allows guest mode, relaxed security
      # 'production' - enforces secure authentication
      environment: {{ .Values.auth.environment | default "production" }}
      session:
        secret: ${AUTH_SESSION_SECRET}
      providers:
        # --------------------------------------------------------------------
        # Guest Access (Development/Testing ONLY)
        # WARNING: Guest mode bypasses all authentication
        # --------------------------------------------------------------------
        {{- if .Values.auth.guest.enabled }}
        guest:
          dangerouslyAllowOutsideDevelopment: {{ .Values.auth.guest.dangerouslyAllowOutsideDevelopment | default false }}
          signIn:
            resolvers:
              - resolver: guestSessionResolver
        {{- end }}

        # --------------------------------------------------------------------
        # GitHub OAuth (Recommended for Production)
        # Securely handles tokens via OAuth2 flow
        # --------------------------------------------------------------------
        {{- if .Values.auth.github.enabled }}
        github:
          {{ .Values.auth.environment | default "production" }}:
            clientId: ${GITHUB_OAUTH_CLIENT_ID}
            clientSecret: ${GITHUB_OAUTH_CLIENT_SECRET}
            {{- if .Values.auth.github.enterpriseInstanceUrl }}
            enterpriseInstanceUrl: {{ .Values.auth.github.enterpriseInstanceUrl }}
            {{- end }}
            # Request additional scopes for GitOps operations
            # These scopes enable the user's OAuth token to be used for repository access
            additionalScopes:
              - repo
              - read:org
              - workflow
            signIn:
              resolvers:
                # Allow any GitHub user without requiring User entity in catalog
                - resolver: usernameMatchingUserEntityName
                  dangerouslyAllowSignInWithoutUserInCatalog: true
        {{- end }}

        # --------------------------------------------------------------------
        # Google OAuth
        # --------------------------------------------------------------------
        {{- if .Values.auth.google.enabled }}
        google:
          {{ .Values.auth.environment | default "production" }}:
            clientId: ${GOOGLE_OAUTH_CLIENT_ID}
            clientSecret: ${GOOGLE_OAUTH_CLIENT_SECRET}
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
        {{- end }}

        # --------------------------------------------------------------------
        # Microsoft/Azure AD OAuth
        # --------------------------------------------------------------------
        {{- if .Values.auth.microsoft.enabled }}
        microsoft:
          {{ .Values.auth.environment | default "production" }}:
            clientId: ${MICROSOFT_OAUTH_CLIENT_ID}
            clientSecret: ${MICROSOFT_OAUTH_CLIENT_SECRET}
            tenantId: ${MICROSOFT_TENANT_ID}
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
        {{- end }}

        # --------------------------------------------------------------------
        # GitLab OAuth
        # --------------------------------------------------------------------
        {{- if .Values.auth.gitlab.enabled }}
        gitlab:
          {{ .Values.auth.environment | default "production" }}:
            clientId: ${GITLAB_OAUTH_CLIENT_ID}
            clientSecret: ${GITLAB_OAUTH_CLIENT_SECRET}
            {{- if .Values.auth.gitlab.baseUrl }}
            baseUrl: {{ .Values.auth.gitlab.baseUrl }}
            {{- end }}
            signIn:
              resolvers:
                - resolver: usernameMatchingUserEntityName
        {{- end }}

    scaffolder:
      defaultAuthor:
        name: {{ .Values.scaffolder.author.name | default "DevOps Portal" }}
        email: {{ .Values.scaffolder.author.email | default "devops@example.com" }}
      defaultCommitMessage: {{ .Values.scaffolder.commitMessage | default "Changes from DevOps Portal" | quote }}

    # ============================================================================
    # Proxy Configuration for External Services
    # ============================================================================
    proxy:
      {{- if .Values.argocd.enabled }}
      '/argocd/api':
        target: {{ .Values.argocd.url }}/api/v1/
        changeOrigin: true
        {{- if .Values.argocd.insecure }}
        secure: false
        {{- else }}
        secure: true
        {{- end }}
        {{- if not .Values.argocd.useServiceAccount }}
        headers:
          Authorization: Bearer ${ARGOCD_TOKEN}
        {{- end }}
      {{- end }}
      {{- if .Values.grafana.enabled }}
      '/grafana/api':
        target: {{ .Values.grafana.url }}/api/
        changeOrigin: true
        headers:
          {{- if eq (default "local" .Values.grafana.type) "cloud" }}
          Authorization: Bearer ${GRAFANA_SA_TOKEN}
          {{- else if .Values.grafana.useServiceAccount }}
          Authorization: Bearer ${GRAFANA_SA_TOKEN}
          {{- else }}
          Authorization: Bearer ${GRAFANA_API_KEY}
          {{- end }}
      {{- end }}

    logging:
      level: {{ .Values.backstage.logLevel | default "info" }}
      format: json

    # ============================================================================
    # Local Authentication Configuration (Username/Password)
    # ============================================================================
    {{- if .Values.localAuth.enabled }}
    localAuth:
      enabled: true
      passwordPolicy:
        minLength: {{ .Values.localAuth.passwordPolicy.minLength | default 12 }}
        requireUppercase: {{ .Values.localAuth.passwordPolicy.requireUppercase | default true }}
        requireLowercase: {{ .Values.localAuth.passwordPolicy.requireLowercase | default true }}
        requireDigit: {{ .Values.localAuth.passwordPolicy.requireDigit | default true }}
        requireSpecial: {{ .Values.localAuth.passwordPolicy.requireSpecial | default true }}
      session:
        maxAge: {{ .Values.localAuth.session.maxAge | default 86400 }}
        secure: {{ .Values.localAuth.session.secure | default true }}
      lockout:
        maxAttempts: {{ .Values.localAuth.lockout.maxAttempts | default 5 }}
        durationSeconds: {{ .Values.localAuth.lockout.durationSeconds | default 900 }}
    {{- else }}
    localAuth:
      enabled: false
    {{- end }}

    {{- if .Values.redis.enabled }}
    # ============================================================================
    # Redis Configuration (Session, Cache, and Optional Queue)
    # ============================================================================
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      {{- if .Values.redis.password }}
      password: ${REDIS_PASSWORD}
      {{- end }}
      {{- if .Values.redis.tls.enabled }}
      tls: true
      {{- end }}
    {{- end }}
