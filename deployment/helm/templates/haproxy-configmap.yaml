{{- if .Values.haproxy.enabled }}
# ============================================================================
# HAProxy Configuration
# ============================================================================
# HAProxy provides internal load balancing and routing for multiple backend
# services. Useful for:
# - Load balancing across multiple DevOps Portal replicas
# - Routing to different backend services (ArgoCD, Grafana, etc.)
# - SSL termination for internal services
# - Health checking and circuit breaking
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "backstage-gitops.fullname" . }}-haproxy
  labels:
    {{- include "backstage-gitops.labels" . | nindent 4 }}
data:
  haproxy.cfg: |
    # ============================================================================
    # HAProxy Configuration for DevOps Portal
    # ============================================================================
    global
        log stdout format raw local0 info
        maxconn 4096
        # Modern SSL settings
        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
        tune.ssl.default-dh-param 2048

    defaults
        log global
        mode http
        option httplog
        option dontlognull
        option http-server-close
        option forwardfor except 127.0.0.0/8
        option redispatch
        retries 3
        timeout connect 5s
        timeout client  30s
        timeout server  30s
        timeout http-request 10s
        timeout http-keep-alive 10s
        timeout queue 30s
        default-server init-addr last,libc,none

    # ============================================================================
    # Stats Dashboard
    # ============================================================================
    frontend stats
        bind *:8404
        mode http
        stats enable
        stats uri /stats
        stats refresh 10s
        stats admin if LOCALHOST

    # ============================================================================
    # Main Frontend - Routes requests to appropriate backends
    # ============================================================================
    frontend http-in
        bind *:{{ .Values.haproxy.port | default 8080 }}
        mode http
        
        # Health check endpoint
        acl health_check path /health
        use_backend health if health_check
        
        # API routing
        acl is_api path_beg /api
        
        # ArgoCD API routing (if enabled)
        {{- if .Values.argocd.enabled }}
        acl is_argocd path_beg /api/argocd
        use_backend argocd if is_argocd
        {{- end }}
        
        # Grafana routing (if enabled)
        {{- if .Values.grafana.enabled }}
        acl is_grafana path_beg /api/grafana
        use_backend grafana if is_grafana
        {{- end }}
        
        # GitLab routing (if enabled)
        {{- if .Values.gitlab.enabled }}
        acl is_gitlab path_beg /api/gitlab
        use_backend gitlab if is_gitlab
        {{- end }}
        
        {{- range .Values.haproxy.customRoutes }}
        acl is_{{ .name }} path_beg {{ .pathPrefix }}
        use_backend {{ .name }} if is_{{ .name }}
        {{- end }}
        
        # Default to DevOps Portal backend
        default_backend devops-portal

    # ============================================================================
    # Backends
    # ============================================================================
    
    # Health check backend
    backend health
        mode http
        http-request return status 200 content-type "text/plain" string "OK"

    # DevOps Portal backend
    backend devops-portal
        mode http
        balance roundrobin
        option httpchk GET /
        http-check expect status 200
        
        # Enable retries and circuit breaking
        option redispatch
        retries 3
        
        # Compression
        compression algo gzip
        compression type text/html text/plain text/css application/json application/javascript
        
        # Server definition
        server devops-portal {{ include "backstage-gitops.fullname" . }}:{{ .Values.service.port }} check inter 5s fall 3 rise 2

    {{- if .Values.argocd.enabled }}
    # ArgoCD backend
    backend argocd
        mode http
        balance roundrobin
        option httpchk GET /healthz
        http-check expect status 200
        
        # Strip /api/argocd prefix before forwarding
        http-request set-path %[path,regsub(^/api/argocd,)]
        
        # Add authorization header if configured
        {{- if .Values.haproxy.argocd.authHeader }}
        http-request set-header Authorization "Bearer ${ARGOCD_TOKEN}"
        {{- end }}
        
        server argocd {{ .Values.argocd.url | trimPrefix "https://" | trimPrefix "http://" }} ssl verify none check inter 10s
    {{- end }}

    {{- if .Values.grafana.enabled }}
    # Grafana backend  
    backend grafana
        mode http
        balance roundrobin
        option httpchk GET /api/health
        http-check expect status 200
        
        # Strip /api/grafana prefix
        http-request set-path %[path,regsub(^/api/grafana,)]
        
        server grafana {{ .Values.grafana.url | trimPrefix "https://" | trimPrefix "http://" }} {{ if hasPrefix "https" .Values.grafana.url }}ssl verify none{{ end }} check inter 10s
    {{- end }}

    {{- if .Values.gitlab.enabled }}
    # GitLab backend
    backend gitlab
        mode http
        balance roundrobin
        option httpchk GET /-/health
        http-check expect status 200
        
        # Strip /api/gitlab prefix
        http-request set-path %[path,regsub(^/api/gitlab,)]
        
        server gitlab {{ .Values.gitlab.url | trimPrefix "https://" | trimPrefix "http://" }} {{ if hasPrefix "https" .Values.gitlab.url }}ssl verify none{{ end }} check inter 10s
    {{- end }}

    {{- range .Values.haproxy.customRoutes }}
    # Custom backend: {{ .name }}
    backend {{ .name }}
        mode http
        balance {{ .balance | default "roundrobin" }}
        {{- if .healthCheck }}
        option httpchk GET {{ .healthCheck.path | default "/" }}
        http-check expect status {{ .healthCheck.expectedStatus | default 200 }}
        {{- end }}
        
        {{- if .stripPrefix }}
        http-request set-path %[path,regsub(^{{ .pathPrefix }},)]
        {{- end }}
        
        {{- range $idx, $server := .servers }}
        server {{ $.name }}-{{ $idx }} {{ $server.address }} {{ if $server.ssl }}ssl verify none{{ end }} check inter {{ $server.checkInterval | default "10s" }}
        {{- end }}
    {{- end }}
{{- end }}
