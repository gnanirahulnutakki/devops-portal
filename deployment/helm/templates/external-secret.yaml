{{- if and .Values.secrets.provider (eq .Values.secrets.provider "external-secrets") }}
# ============================================================================
# External Secrets - Integration with External Secret Stores
# ============================================================================
# External Secrets Operator synchronizes secrets from external APIs
# (HashiCorp Vault, AWS Secrets Manager, Azure Key Vault, GCP Secret Manager)
# into Kubernetes Secrets.
#
# Prerequisites:
#   - External Secrets Operator installed:
#     helm repo add external-secrets https://charts.external-secrets.io
#     helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#   - SecretStore or ClusterSecretStore configured for your provider
# ============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.secrets.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "backstage-gitops.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval | default "1h" }}
  
  {{- if .Values.secrets.externalSecrets.secretStoreRef }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStoreRef.kind | default "SecretStore" }}
  {{- end }}
  
  target:
    name: {{ .Values.secrets.name }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "backstage-gitops.labels" . | nindent 10 }}
  
  data:
    {{- if .Values.secrets.externalSecrets.data }}
    {{- range .Values.secrets.externalSecrets.data }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
        {{- if .version }}
        version: {{ .version }}
        {{- end }}
    {{- end }}
    {{- else }}
    # Default secret mappings - adjust remoteKey paths based on your vault structure
    - secretKey: GITHUB_TOKEN
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.basePath | default "devops-portal" }}/github
        property: token
    - secretKey: GITHUB_OAUTH_CLIENT_ID
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.basePath | default "devops-portal" }}/github-oauth
        property: client_id
    - secretKey: GITHUB_OAUTH_CLIENT_SECRET
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.basePath | default "devops-portal" }}/github-oauth
        property: client_secret
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.basePath | default "devops-portal" }}/postgres
        property: password
    - secretKey: AUTH_SESSION_SECRET
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.basePath | default "devops-portal" }}/auth
        property: session_secret
    {{- if $.Values.argocd.enabled }}
    - secretKey: ARGOCD_TOKEN
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.basePath | default "devops-portal" }}/argocd
        property: token
    {{- end }}
    {{- end }}
{{- end }}

---
{{- if and .Values.secrets.provider (eq .Values.secrets.provider "external-secrets") .Values.secrets.externalSecrets.createSecretStore }}
# ============================================================================
# SecretStore Configuration
# ============================================================================
# This creates a SecretStore resource for connecting to your secret provider.
# Only created if secrets.externalSecrets.createSecretStore is true.
# ============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.secrets.externalSecrets.secretStoreRef.name | default "devops-portal-secret-store" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "backstage-gitops.labels" . | nindent 4 }}
spec:
  provider:
    {{- if eq .Values.secrets.externalSecrets.provider "hashicorp-vault" }}
    # HashiCorp Vault Configuration
    vault:
      server: {{ .Values.secrets.externalSecrets.vault.server | quote }}
      path: {{ .Values.secrets.externalSecrets.vault.path | default "secret" | quote }}
      version: {{ .Values.secrets.externalSecrets.vault.version | default "v2" | quote }}
      {{- if .Values.secrets.externalSecrets.vault.namespace }}
      namespace: {{ .Values.secrets.externalSecrets.vault.namespace | quote }}
      {{- end }}
      auth:
        {{- if .Values.secrets.externalSecrets.vault.auth.kubernetes }}
        # Kubernetes Auth Method
        kubernetes:
          mountPath: {{ .Values.secrets.externalSecrets.vault.auth.kubernetes.mountPath | default "kubernetes" }}
          role: {{ .Values.secrets.externalSecrets.vault.auth.kubernetes.role | quote }}
          {{- if .Values.secrets.externalSecrets.vault.auth.kubernetes.serviceAccountRef }}
          serviceAccountRef:
            name: {{ .Values.secrets.externalSecrets.vault.auth.kubernetes.serviceAccountRef.name }}
          {{- end }}
        {{- else if .Values.secrets.externalSecrets.vault.auth.token }}
        # Token Auth Method
        tokenSecretRef:
          name: {{ .Values.secrets.externalSecrets.vault.auth.token.secretName }}
          key: {{ .Values.secrets.externalSecrets.vault.auth.token.key | default "token" }}
        {{- else if .Values.secrets.externalSecrets.vault.auth.appRole }}
        # AppRole Auth Method
        appRole:
          path: {{ .Values.secrets.externalSecrets.vault.auth.appRole.path | default "approle" }}
          roleId: {{ .Values.secrets.externalSecrets.vault.auth.appRole.roleId | quote }}
          secretRef:
            name: {{ .Values.secrets.externalSecrets.vault.auth.appRole.secretRef.name }}
            key: {{ .Values.secrets.externalSecrets.vault.auth.appRole.secretRef.key | default "secret-id" }}
        {{- end }}
    {{- else if eq .Values.secrets.externalSecrets.provider "azure-keyvault" }}
    # Azure Key Vault Configuration
    azurekv:
      vaultUrl: {{ .Values.secrets.externalSecrets.azure.vaultUrl | quote }}
      {{- if .Values.secrets.externalSecrets.azure.tenantId }}
      tenantId: {{ .Values.secrets.externalSecrets.azure.tenantId | quote }}
      {{- end }}
      authType: {{ .Values.secrets.externalSecrets.azure.authType | default "ManagedIdentity" }}
      {{- if eq .Values.secrets.externalSecrets.azure.authType "ServicePrincipal" }}
      authSecretRef:
        clientId:
          name: {{ .Values.secrets.externalSecrets.azure.authSecretRef.name }}
          key: client-id
        clientSecret:
          name: {{ .Values.secrets.externalSecrets.azure.authSecretRef.name }}
          key: client-secret
      {{- end }}
    {{- else if eq .Values.secrets.externalSecrets.provider "aws-secrets-manager" }}
    # AWS Secrets Manager Configuration
    aws:
      service: SecretsManager
      region: {{ .Values.secrets.externalSecrets.aws.region | quote }}
      {{- if .Values.secrets.externalSecrets.aws.role }}
      role: {{ .Values.secrets.externalSecrets.aws.role | quote }}
      {{- end }}
      {{- if .Values.secrets.externalSecrets.aws.auth }}
      auth:
        {{- if .Values.secrets.externalSecrets.aws.auth.secretRef }}
        secretRef:
          accessKeyIDSecretRef:
            name: {{ .Values.secrets.externalSecrets.aws.auth.secretRef.name }}
            key: access-key-id
          secretAccessKeySecretRef:
            name: {{ .Values.secrets.externalSecrets.aws.auth.secretRef.name }}
            key: secret-access-key
        {{- else }}
        jwt:
          serviceAccountRef:
            name: {{ include "backstage-gitops.serviceAccountName" . }}
        {{- end }}
      {{- end }}
    {{- else if eq .Values.secrets.externalSecrets.provider "gcp-secret-manager" }}
    # GCP Secret Manager Configuration
    gcpsm:
      projectID: {{ .Values.secrets.externalSecrets.gcp.projectID | quote }}
      {{- if .Values.secrets.externalSecrets.gcp.auth }}
      auth:
        {{- if .Values.secrets.externalSecrets.gcp.auth.secretRef }}
        secretRef:
          secretAccessKeySecretRef:
            name: {{ .Values.secrets.externalSecrets.gcp.auth.secretRef.name }}
            key: {{ .Values.secrets.externalSecrets.gcp.auth.secretRef.key | default "credentials.json" }}
        {{- else }}
        workloadIdentity:
          clusterLocation: {{ .Values.secrets.externalSecrets.gcp.auth.workloadIdentity.clusterLocation }}
          clusterName: {{ .Values.secrets.externalSecrets.gcp.auth.workloadIdentity.clusterName }}
          serviceAccountRef:
            name: {{ include "backstage-gitops.serviceAccountName" . }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}
